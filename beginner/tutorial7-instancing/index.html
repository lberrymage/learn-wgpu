<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Instancing | Learn Wgpu</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <meta property="article:modified_time" content="2020-09-05T22:45:52.000Z">
    <meta property="og:site_name" content="Learn Wgpu">
    <meta property="og:title" content="Instancing">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/beginner/tutorial7-instancing/">
    <meta name="twitter:title" content="Instancing">
    <meta name="twitter:url" content="/beginner/tutorial7-instancing/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data2" content="Benjamin R Hansen">
    <meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.252006b7.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.697b5c3f.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.e9a59387.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/15.36548305.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/20.ce60df80.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/10.9e1f31eb.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.2372e518.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.111400eb.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.11f75040.js"><link rel="prefetch" href="/learn-wgpu/assets/js/14.007e8744.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.cd023de5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.8a1506a6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.1117981f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.d3e3b90b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.45ff5931.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.7e3c1dd6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.e51ebc42.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.8a90624b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.1b845a25.js"><link rel="prefetch" href="/learn-wgpu/assets/js/26.d74159a4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/3.2b418fcc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.a640991f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.aa005839.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.be194231.js"><link rel="prefetch" href="/learn-wgpu/assets/js/7.e2f2ab5f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/8.6f1c2f0a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.f4a67691.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.252006b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">Dependencies and the window</a></li><li><a href="/learn-wgpu/beginner/tutorial2-swapchain/" class="sidebar-link">The Swapchain</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">The Pipeline</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">Buffers and Indices</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">Textures and bind groups</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform buffers and a 3d camera</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="active sidebar-link">Instancing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#the-instance-buffer" class="sidebar-link">The Instance Buffer</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#storage-buffers" class="sidebar-link">Storage Buffers</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#gl-instanceindex" class="sidebar-link">gl_InstanceIndex</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/beginner/tutorial7-instancing/#challenge" class="sidebar-link">Challenge</a></li></ul></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">The Depth Buffer</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">Model Loading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">Working with Lights</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">Normal Mapping</a></li><li><a href="/learn-wgpu/intermediate/tutorial12-camera/" class="sidebar-link">A Better Camera</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/learn-wgpu/news/" class="sidebar-link">News</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="instancing"><a href="#instancing" class="header-anchor">#</a> Instancing</h1> <p>Our scene right now is very simple: we have one object centered at (0,0,0). What if we wanted more objects? This is were instancing comes in.</p> <p>Instancing allows use to draw the same object multiple times with different properties (position, orientation, size, color, etc.). There are multiple ways of doing instancing. One way would be to modify the uniform buffer to include these properties and then update it before we draw each instance of our object.</p> <p>We don't want to use this method for performance reasons. Updating the uniform buffer for each instance would require multiple buffer copies each frame. On top of that, our method to update the uniform buffer currently requires use to create a new buffer to store the updated data. That's a lot of time wasted between draw calls.</p> <p>If we look at the parameters for the <code>draw_indexed</code> function <a href="https://docs.rs/wgpu/0.5.2/wgpu/struct.RenderPass.html#method.draw_indexed" target="_blank" rel="noopener noreferrer">in the wgpu docs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we can see a solution to our problem.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">draw_indexed</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
    indices<span class="token punctuation">:</span> Range<span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    base_vertex<span class="token punctuation">:</span> i32<span class="token punctuation">,</span>
    instances<span class="token punctuation">:</span> Range<span class="token operator">&lt;</span>u32<span class="token operator">&gt;</span> <span class="token comment">// &lt;-- This right here</span>
<span class="token punctuation">)</span>
</code></pre></div><p>The <code>instances</code> parameter takes a <code>Range&lt;u32&gt;</code>. This parameter tells the GPU how many copies, or instances, of our model we want to draw. Currently we are specifying <code>0..1</code>, which the GPU will draw our model once, and then it will stop. If we used <code>0..5</code>, our code would draw 5 instances.</p> <p>The fact that <code>instances</code> is a <code>Range&lt;u32&gt;</code> may seem weird as using <code>1..2</code> for instances would still draw 1 instance of our object. Seems like it would be simpler to just use a <code>u32</code> right? The reason it's a range is because sometimes we don't want to draw <strong>all</strong> of our objects. Sometimes we want to draw a selection of them, because others are not in frame, our we are debugging and want to look at a particular set of instances.</p> <p>Ok, now we know how to draw multiple instances of an object, how do we tell wgpu what particular instance to draw? We are going to use something known as an instance buffer.</p> <h2 id="the-instance-buffer"><a href="#the-instance-buffer" class="header-anchor">#</a> The Instance Buffer</h2> <p>We'll create an instance buffer in a similar way to how we create a uniform buffer. First we'll create a struct called <code>Instance</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main.rs</span>
<span class="token comment">// ...</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">struct</span> Instance <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    rotation<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Quaternion<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="note"><p>A <code>Quaternion</code> is a mathematical structure often used to represent rotation. The math behind them is beyond me (it involves imaginary numbers and 4D space) so I won't be covering them here. If you really want to dive into them <a href="https://mathworld.wolfram.com/Quaternion.html" target="_blank" rel="noopener noreferrer">here's a Wolfram Alpha article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></div> <p>Using these values directly in the shader would be a pain as quaternions don't have a GLSL analog. I don't feel like writing the math in the shader, so we'll convert the <code>Instance</code> data into a matrix and store it into a struct called <code>InstanceRaw</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone)]</span>
<span class="token keyword">struct</span> InstanceRaw <span class="token punctuation">{</span>
    model<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> bytemuck<span class="token punctuation">::</span>Pod <span class="token keyword">for</span> InstanceRaw <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">unsafe</span> <span class="token keyword">impl</span> bytemuck<span class="token punctuation">::</span>Zeroable <span class="token keyword">for</span> InstanceRaw <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>This is the data to will go into the <code>wgpu::Buffer</code>. We keep these separate so that we can update the <code>Instance</code> as much as we want without needing to mess with matrices. We only need to update the raw data before we draw.</p> <p>Let's create a method on <code>Instance</code> to convert to <code>InstanceRaw</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token keyword">impl</span> Instance <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function">to_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> InstanceRaw <span class="token punctuation">{</span>
        InstanceRaw <span class="token punctuation">{</span>
            model<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">from_translation</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token operator">*</span> cgmath<span class="token punctuation">::</span>Matrix4<span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we need to add 2 fields to <code>State</code>: <code>instances</code>, and <code>instance_buffer</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> State <span class="token punctuation">{</span>
    instances<span class="token punctuation">:</span> Vec<span class="token operator">&lt;</span>Instance<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[allow(dead_code)]</span>
    instance_buffer<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>Buffer<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We'll create the instances in <code>new()</code>. We'll use some constants to simplify things. We'll display our instances in 10 rows of 10, and they'll be spaced evenly apart.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> NUM_INSTANCES_PER_ROW<span class="token punctuation">:</span> u32 <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> NUM_INSTANCES<span class="token punctuation">:</span> u32 <span class="token operator">=</span> NUM_INSTANCES_PER_ROW <span class="token operator">*</span> NUM_INSTANCES_PER_ROW<span class="token punctuation">;</span>
<span class="token keyword">const</span> INSTANCE_DISPLACEMENT<span class="token punctuation">:</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token operator">&lt;</span>f32<span class="token operator">&gt;</span> <span class="token operator">=</span> cgmath<span class="token punctuation">::</span>Vector3<span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>NUM_INSTANCES_PER_ROW <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> NUM_INSTANCES_PER_ROW <span class="token keyword">as</span> f32 <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we can create the actual instances.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> State <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span>Window<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>NUM_INSTANCES_PER_ROW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token punctuation">|</span>z<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>NUM_INSTANCES_PER_ROW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token punctuation">|</span>x<span class="token punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> position <span class="token operator">=</span> cgmath<span class="token punctuation">::</span>Vector3 <span class="token punctuation">{</span> x<span class="token punctuation">:</span> x <span class="token keyword">as</span> f32<span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> z <span class="token keyword">as</span> f32 <span class="token punctuation">}</span> <span class="token operator">-</span> INSTANCE_DISPLACEMENT<span class="token punctuation">;</span>

                <span class="token keyword">let</span> rotation <span class="token operator">=</span> <span class="token keyword">if</span> position<span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// this is needed so an object at (0, 0, 0) won't get scaled to zero</span>
                    <span class="token comment">// as Quaternions can effect scale if they're not created correctly</span>
                    cgmath<span class="token punctuation">::</span>Quaternion<span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>cgmath<span class="token punctuation">::</span>Vector3<span class="token punctuation">::</span><span class="token function">unit_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cgmath<span class="token punctuation">::</span><span class="token function">Deg</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    cgmath<span class="token punctuation">::</span>Quaternion<span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cgmath<span class="token punctuation">::</span><span class="token function">Deg</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                Instance <span class="token punctuation">{</span>
                    position<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">::</span><span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now that we have our data, we can create the actual <code>instance_buffer</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_data <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Instance<span class="token punctuation">::</span>to_raw<span class="token punctuation">)</span><span class="token punctuation">.</span>collect<span class="token punctuation">::</span><span class="token operator">&lt;</span>Vec<span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span>BufferInitDescriptor <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Instance Buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contents<span class="token punctuation">:</span> bytemuck<span class="token punctuation">::</span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BufferUsage<span class="token punctuation">::</span>STORAGE<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We need a way to bind our new instance buffer so we can use it in the vertex shader. We could create a new bind group (and we probably should), but for simplicity, I'm going to add a binding to the <code>uniform_bind_group</code> that references our <code>instance_buffer</code>.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> uniform_bind_group_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupLayoutDescriptor <span class="token punctuation">{</span>
    entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// NEW!</span>
        wgpu<span class="token punctuation">::</span>BindGroupLayoutEntry <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            visibility<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>ShaderStage<span class="token punctuation">::</span>VERTEX<span class="token punctuation">,</span>
            ty<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingType<span class="token punctuation">::</span>StorageBuffer <span class="token punctuation">{</span>
                <span class="token comment">// We don't plan on changing the size of this buffer</span>
                dynamic<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
                <span class="token comment">// The shader is not allowed to modify it's contents</span>
                readonly<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
                min_binding_size<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            count<span class="token punctuation">:</span> None<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    label<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token string">&quot;uniform_bind_group_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> uniform_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wgpu<span class="token punctuation">::</span>BindGroupDescriptor <span class="token punctuation">{</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>uniform_bind_group_layout<span class="token punctuation">,</span>
    entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// NEW!</span>
        wgpu<span class="token punctuation">::</span>BindGroupEntry <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> wgpu<span class="token punctuation">::</span>BindingResource<span class="token punctuation">::</span><span class="token function">Buffer</span><span class="token punctuation">(</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    label<span class="token punctuation">:</span> <span class="token function">Some</span><span class="token punctuation">(</span><span class="token string">&quot;uniform_bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Don't forget to return our new variables!</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NEW!</span>
    instances<span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The last change we need to make is in the <code>render()</code> method. We need to change the range we're using in <code>draw_indexed()</code> to include use the number of instances.</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>uniform_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// UPDATED!</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning"><p>Make sure if you add new instances to the <code>Vec</code> that you recreate the <code>instance_buffer</code> and as well as <code>uniform_bind_group</code>, otherwise you're new instances won't show up correctly.</p></div> <h2 id="storage-buffers"><a href="#storage-buffers" class="header-anchor">#</a> Storage Buffers</h2> <p>When we modified <code>uniform_bind_group_layout</code>, we specified that our <code>instance_buffer</code> would be of type <code>wgpu::BindingType::StorageBuffer</code>. A storage buffer functions like an array that persists between shader invocations. Let's take a look at what it looks like in <code>shader.vert</code>.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">layout</span><span class="token punctuation">(</span>set<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> binding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
<span class="token keyword">buffer</span> Instances <span class="token punctuation">{</span>
    <span class="token keyword">mat4</span> s_models<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>We declare a storage buffer in a very similar way to how we declare a uniform block. The only real difference is that we use the <code>buffer</code> keyword. We can then use <code>s_models</code> to position our models in the scene. But how do we know what instance to use?</p> <h2 id="gl-instanceindex"><a href="#gl-instanceindex" class="header-anchor">#</a> gl_InstanceIndex</h2> <p>This GLSL variable let's use specify what instance we want to use. We can use the <code>gl_InstanceIndex</code> to index our <code>s_models</code> buffer to get the matrix for the current model.</p> <div class="language-glsl extra-class"><pre class="language-glsl"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v_tex_coords <span class="token operator">=</span> a_tex_coords<span class="token punctuation">;</span>
    <span class="token comment">// UPDATED!</span>
    gl_Position <span class="token operator">=</span> u_view_proj <span class="token operator">*</span> s_models<span class="token punctuation">[</span>gl_InstanceIndex<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token keyword">vec4</span><span class="token punctuation">(</span>a_position<span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="note"><p>The value of <code>gl_InstanceIndex</code> is based on the range passed to the <code>instances</code> parameter of <code>draw_indexed</code>. Using <code>3..instances.len() as _</code> would mean that the 1st-3rd instances would be skipped.</p></div> <p>With all that done, we should have a forest of trees!</p> <p><img src="/learn-wgpu/assets/img/forest.5c5cf3ad.png" alt="./forest.png"></p> <h2 id="challenge"><a href="#challenge" class="header-anchor">#</a> Challenge</h2> <p>Modify the position and/or rotation of the instances every frame.</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial7-instancing/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/5/2020, 4:45:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="prev">
          Uniform buffers and a 3d camera
        </a></span> <span class="next"><a href="/learn-wgpu/beginner/tutorial8-depth/">
          The Depth Buffer
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.697b5c3f.js" defer></script><script src="/learn-wgpu/assets/js/2.e9a59387.js" defer></script><script src="/learn-wgpu/assets/js/15.36548305.js" defer></script><script src="/learn-wgpu/assets/js/20.ce60df80.js" defer></script>
  </body>
</html>
